'use strict';
// preloader
const uploadPreloader = function() {
  setTimeout(function() {
    const preloader = document.getElementById('page-preloader');
    if (!preloader.classList.contains('done')) {
      preloader.classList.add('done');
    }
  }, 1200);
};

uploadPreloader();

// image viewer
const ESC_KEYCODE = 27;
const galleryImage = document.querySelectorAll('.gallery__image');
const overlay = document.querySelector('.overlay');
const overlayClose = overlay.querySelector('.overlay-close');

function close() {
  overlay.classList.remove('open');
}

function onCloseButtonClick(e) {
  const overlayImage = overlay.querySelector('.overlay-image');
  const imageSrc = e.currentTarget.src;
  overlayImage.src = imageSrc;
  overlay.classList.add('open');
}

galleryImage.forEach(img => img.addEventListener('click', onCloseButtonClick));
overlayClose.addEventListener('click', close);

// keyCode close
document.addEventListener('keydown', function(evt) {
  if (evt.keyCode === 27) {
    overlay.classList.remove('open');
  }
});

// special post animation
// debounce fn for scroll listener
function debounce(fn, wait = 20, immediate = true) {
  var timeout;
  return function() {
    var context = this,
      args = arguments;
    var later = function() {
      timeout = null;
      if (!immediate) fn.apply(context, args);
    };
    var callNow = immediate && !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (callNow) fn.apply(context, args);
  };
}

// control position
const sliderImages = document.querySelectorAll('.slide-in');

function checkSlide(evt) {
  sliderImages.forEach(sliderImage => {
    // scroll from display top to half size image
    const slideInAt =
      window.scrollY + window.innerHeight - sliderImage.height / 2;

    // get image bottom point
    const imageBottom = sliderImage.offsetTop + sliderImage.height;

    // add-remove active class
    const isHalfShown = slideInAt > sliderImage.offsetTop;
    const isNotScroll = window.scrollY < imageBottom;

    if (isHalfShown && isNotScroll) {
      sliderImage.classList.add('active');
    } else {
      sliderImage.classList.remove('active');
    }
  });
}

window.addEventListener('scroll', debounce(checkSlide));
